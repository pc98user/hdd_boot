

●トランジスタ技術 SPECIAL No.3
　特集 PC9801と拡張インターフェースのすべて

○P.32-33「ROMによるオートスタート」
「オフセットの09h番地が55hでOAh番地がAAhであるかを見て，
そうであればオフセットの06h番地へFAR CALLしてきます．」

・初代では00h番地コールのはず。(UNDOCUMENTEDの記述より。)

●UNDOCUMENTED 9801/9821 Vol.2 - メモリ・I/Oポート編
　https://www.webtech.co.jp/company/doc/undocumented_mem/index.html
○memsys.txt
メモリ	0000:04B0～04BFh
内容	拡張DISK BIOSテーブル

      u	PC-9801初代の本体内BIOSは、拡張DISK BIOS(拡張ROM)を認識する機能を持って
	いない。しかし、PC-9801-08(PC-9801初代専用2DD FD I/F)付属のROMを
	本体内のソケットに実装したときは、拡張DISK BIOSを認識できる
	ようになる。このとき、この拡張DISK BIOSテーブルを使用する。
→PC-9801-08に交換用のROMがついているらしい。
      u このテーブルは、拡張ROM(拡張DISK BIOS)内の初期化ルーチンが設定する。
	リセット後、本体内BIOS(PC-9801初代を除く)は初期化処理の中で、
	ジャンプテーブルを持つ拡張ROMの有無をチェックする。ジャンプテーブルを
	持つ拡張ROMが存在していると判断すると、本体内BIOSは拡張ROMのジャンプ
	テーブル内にある初期化ルーチンのエントリ3箇所(オフセット000Ch,000Fh,
	0012h)を順次FAR CALLする。拡張ROMがDISK BIOSを拡張するものであるなら
	(つまり拡張DISK BIOSなら)、拡張ROMは初期化ルーチンのなかで、この
	拡張DISK BIOSテーブルを設定する。
→初代には当てはまらないので参考まで。トラ技には06hとあるが？

○memsys.txt
メモリ	0000:04C0～04F3h
内容	拡張ROM IDテーブル
      u このテーブルは、拡張ROM内の初期化ルーチンが設定する。
	リセット後、本体内BIOS(PC-9801初代を除く)は初期化処理の中で、
	ジャンプテーブルを持つ拡張ROMの有無をチェックする。ジャンプテーブルを
	持つ拡張ROMが存在していると判断すると、本体内BIOSは拡張ROMのジャンプ
	テーブル内にある初期化ルーチンのエントリ3箇所(オフセット000Ch,000Fh,
	0012h)を順次FAR CALLする。拡張ROM IDは、オフセット000Chの初期化
	ルーチン内で設定される。
→初代には当てはまらないので参考まで。拡張ROMの有無のチェックは同じ？
      u PC-9801初代の本体内BIOSは、拡張ROMを認識する機能を持っていないので、
	このワークエリアを使用しない。PC-9801-08(PC-9801初代専用 2DD I/F)
	付属のROMを本体内のソケットに実装したときは、拡張ROMを認識できるように
	なるが、このワークエリアは使用しない。拡張ROMのジャンプテーブル内に
	あるPC-9801初代専用の初期化ルーチンのエントリ(オフセット0000h)を
	FAR CALLするのみだからである。
→実験の通り、0000hであっている。

●PC-9800シリーズ
　テクニカルデータブック BIOS編

○PC-9801の場合、内部割り込みコード01BHとある。
・ここでいう「PC-9801」とは、「PC-9801初代」のことと思われる。
・「01BH」は「0B1H」の誤りと思われる。

○BIOSコマンド使用上の注意
　AHレジスタの0〜3ビットでコマンドコードを指定するが、コマンドに該当しないコードが指定された場合は正常終了(CF=0)する。
→成功なのか実行していないのか分からない。使いにくい。

●PC-9800シリーズ
　テクニカルデータブック HARDWARE編
○第８章 ブートストラップ
  HDのとき、IPLレコードのロードアドレスは1FE0H:0000H(FDは1FC0H:0000H)
・もともとHDD起動に対応していないので、どうでも良い値かもしれない。
→FDは1FC0Hでないと起動しないようだ。

●ＤＩＳＫに関する資料 　第２稿(Vector)
○＜NEC HD IPL v5.0の逆ｱｾﾝﾌﾞﾙ＞
1FC0:0048 BB0001         MOV	BX,0100 	;256
1FC0:004B B484           MOV	AH,84 
1FC0:004D CD1B           INT	1B 		;PC98 DISK BIOS  AX=8400
→SASIは新SENSEをサポートしていないからか、あらかじめセクタサイズ(256)をセットしている？

●実験
○PC-9801-27
・PC-9801-27を挿した場合、D700:0000に拡張ROMが現れる。
　→D600固定との記述を見かけるが、間違いか、初代は違うのか？
・ジャンパ設定は2-7,4-5とされているが、これだとROMが現れない。
　ROM CALLしたい場合は"その他"の設定1-8,4-5にすると現れる。
・初代の場合は、拡張ROMを認識しない仕様なので、本体ROMにSASI BIOSがあるのではないか？
　(int 0b1hの記述があることから。)
・だだしそのROMはPC-9801-07用でなないか？
　→PC-9801-27でint 0B1hを使うと、リブートした。07では試していない。

・D700:0000をFAR CALLすると、
　・数秒経過し、アクセスランプが1回点滅する。何らかの初期化が行われているのではないか？
　・0000:0584が81hになる。→意図不明。→後述
　・0000:04B0と04B8がD7hになる。→意図通り。
　・FD-IPLwareのIPLwareアプリケーションとして実施した場合、元のIPLwareに戻れない。
　　リターンアドレスの内容(1fc0:0000あたり)がゼロクリアされていた。
　　→もっとも、初代ではFD-IPLwareのブートセレクタは機能していないようだ。
　　　(ROM BASICのみ起動できるが、FD他はリセットがかかっているようだ。)

○PC-9801-55
・CPC-SCSI55やIF-2750など、"98E/F/M"でのディップスイッチは
　D400設定になっているが、初代でもそうしたほうが良いのか？
　→そうしてみた。その場合、D400:0000に拡張ROMが現れる。
・D400:0000をFAR CALLすると、やはり何らかの初期化が行われているようだ。
　・0000:04B2と04BAと04BCがD4hになる。→意図通り。
　・この場合、FD-IPLwareに戻れる。
　　ただし、やはりSCSIを選択してもブートはできない。(リセットがかかる。)
・メモリスイッチSSW4、bit5に拡張ROM(D4000h - D5FFFh)(GP-IB BIOS)の有効ビットがあるので、ONにしてみる。
　→MS-DOS6.2を起動しても認識していない。
　→ROM BASICの起動時(How many files?のあと)に時間がかる。0000:04B2がD4hになる。
　　ROM BASICが参照する設定のようだ。(トラ技にもそう書いてあった。)

○READ DATA
AH=06h
・FDの場合、0d6hを指定すべきのようだ。
AL=DA/UA=80h
BX=データサイズ
・1024のときは1024なのか4(=256*4)なのか？
　→1024のようだ。
CX=シリンダ番号(0〜)
DH=ヘッド番号(0〜)
DL=セクタ番号(0〜)
・FDの場合、1〜のようだ。
ES:BP=データバッファアドレス

○DOSでの認識
・MS-DOS6.2を起動したとき、SASIもSCSIもハードディスクを認識していない。
・MD-DOS3.3であれば、両方認識している。
　→初代を認識して、BIOS初期化をCALLしているのか？
・6.2でも、IPL-wareでROM初期化(D400:0000をFAR CALL)しておくと、認識した。
　(SASIの方は未確認。)
・FD/HDでは起動したデバイスがAドライブ(若いドライブレター側)になるが、
　SASI/SCSIではどちらから起動しても、SASI側がAドライブになる。

○BIOS初期化・ブート
・SASIで初期化(D700:0000コール)した場合、
　SASIドライブにブート可能デバイスが存在していると、そのデバイスからブートする。
　(ID=0の起動のみ確認。ブート可能デバイスが存在しない場合は0000:0584が81hで
　復帰することから、ID=1でもブートを試みているはず。)
・SCSIで初期化(D400:0000コール)した場合は、SASIのようにはブートしない。
　自前でブートセクタをロードしてキックする必要がある。
→SASIからブートさせるなら、SCSIの方から初期化しなければならない。
※DOS6.2インストール時、フォーマット・システムコピー後に一回再起動が入るが、
　継続してFDからブートさせたいので、一旦HDDをBOOT不可に設定する必要がある。

○ROM初期化エントリポイント
エントリポイントはいくつかあるようだ。
0000h…memsys.txtの記述
0006h…トラ技の記述
000ch,000fh,0012h…memsys.txtの記述

     0000h  0006h 000ch  000fh   0012h
SASI ブート NOP   初期化 ハング  (未実施)
SCSI 初期化 NOP   NOP?   初期化? NOP?

　初期化…04B0hエントリに値が入ることを確認

SASIの000chは初期化はされているようだが、DOS6.2では認識されていなかった。
SCSIの000ch,000fh,0012hはセットで実施したほうが良いと思われる。

○FD-IPLware
IPLwareアプリは6000hで実行されるため、IPLの再ロード(上書き)に都合が良い。
※FDのロードアドレスは1FC0、HDは1FE0なので、
　HD起動の場合に限り、直接IPLで実装しても良いのかもしれない。

